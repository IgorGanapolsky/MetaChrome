name: Orchestrate CI + LangSmith + RAG

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref to test"
        required: false
        default: main
      notify_slack:
        description: "Post status to Slack (requires secret SLACK_WEBHOOK_URL)"
        required: false
        default: "false"
  schedule:
    - cron: "15 12 * * *" # daily sanity run

jobs:
  dispatch:
    runs-on: ubuntu-latest
    env:
      SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      OWNER: IgorGanapolsky
      REPO: MetaChrome
    steps:
      - name: Set ref
        id: ref
        run: echo "ref=${{ github.event.inputs.ref || 'main' }}" >> "$GITHUB_OUTPUT"

      - name: Dispatch CI
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$OWNER/$REPO/actions/workflows/ci.yml/dispatches \
            -d "{\"ref\":\"${{ steps.ref.outputs.ref }}\"}"

      - name: Dispatch LangSmith Sync
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$OWNER/$REPO/actions/workflows/langsmith-sync.yml/dispatches \
            -d "{\"ref\":\"${{ steps.ref.outputs.ref }}\"}"

      - name: Dispatch RAG Ingest
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/$OWNER/$REPO/actions/workflows/rag-ingest.yml/dispatches \
            -d "{\"ref\":\"${{ steps.ref.outputs.ref }}\"}"

      - name: Slack notify (optional)
        if: ${{ github.event.inputs.notify_slack == 'true' }}
        env:
          REF: ${{ steps.ref.outputs.ref }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "No SLACK_WEBHOOK_URL set; skipping Slack notify."
          else
            msg='{"text":":rocket: Orchestrated runs kicked off for '$REF' (CI + LangSmith + RAG)."}'
            curl -X POST -H 'Content-Type: application/json' --data "$msg" "$SLACK_WEBHOOK_URL"
          fi
